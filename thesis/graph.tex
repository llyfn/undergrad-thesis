\documentclass[tikz, border=10pt]{standalone}
\usepackage{tikz}
\usetikzlibrary{shapes.geometric, arrows.meta, positioning, calc}

\begin{document}
    \tikzset{
        title/.style={font=\Large\bfseries},
        block/.style={rectangle, rounded corners, text width=5cm, minimum height=1.2cm, text centered, draw=black, fill=gray!20},
        space/.style={rectangle, rounded corners, minimum width=6cm, minimum height=4.5cm, draw=black!80, fill=gray!10, text centered},
        output/.style={diamond, aspect=2, minimum size=1.5cm, text centered, draw=black, fill=gray!20},
        main_arrow/.style={thick, -Triangle, line width=1pt},
        update_arrow/.style={thick, dashed, -Triangle, draw=red!80, rounded corners},
        sarc_emb/.style={circle, fill=red!60, draw=black, minimum size=8pt, inner sep=0pt},
        norm_emb/.style={rectangle, fill=blue!60, draw=black, minimum size=8pt, inner sep=0pt},
        force_arrow/.style={-stealth, dashed}
    }

    \begin{tikzpicture}[node distance=1cm]

        % --- Title ---
        \node (title) [title] {Stage 1: Supervised Contrastive Pre-training};

        % --- Input Data ---
        \node (input) [block, below=of title] {Batch of Labeled Inputs \\ \small(\texttt{context [SEP] response, label})};

        % --- RoBERTa Encoder ---
        \node (encoder) [block, below=of input] {RoBERTa Encoder};
        \draw [main_arrow] (input) -- (encoder);

        % --- Embedding Space ---
        \node (emb_space) [space, below=of encoder] {};
        \node [above] at (emb_space.south) {\textbf{Embedding Space}};
        \draw [main_arrow] (encoder) -- (emb_space) node [midway, right, font=\small] {Generate Embeddings};

        % Coordinates for embedding clusters
        \coordinate (c1) at ($(emb_space.center)+(-1.5, 1.3)$); % Sarcastic cluster
        \coordinate (c2) at ($(emb_space.center)+(1.3, -0.7)$); % Not Sarcastic cluster

        % Sarcastic Embeddings (Circles)
        \node[sarc_emb] (s1) at (c1) {};
        \node[sarc_emb] (s2) at ($(c1)+(-0.4,-0.4)$) {};
        \node[sarc_emb, label={[font=\small]right:$h_{sarc}$}] (s3) at ($(c1)+(0.1,-0.5)$) {};

        % Not Sarcastic Embeddings (Squares)
        \node[norm_emb] (n1) at (c2) {};
        \node[norm_emb] (n2) at ($(c2)+(0.5,-0.1)$) {};
        \node[norm_emb, label={[font=\small]right:$h_{norm}$}] (n3) at ($(c2)+(0.1,-0.5)$) {};

        % Force arrows illustrating the contrastive objective
        \draw[force_arrow, black, bend right=70] (s1) to node[midway, above, sloped, font=\small] {attract} (s2);
        \draw[force_arrow, black, bend left=70] (n1) to node[midway, above, sloped, font=\small] {attract} (n2);
        \draw[force_arrow, black, <->] (s2) to node[midway, below right, sloped, font=\small] {repel} (n3);

        % --- Loss Function ---
        \node (loss) [block, below=of emb_space] {Supervised Contrastive Loss};
        \draw [main_arrow] (emb_space) -- (loss);

        % --- Weight Update Path ---
        \draw [update_arrow] (loss.west) -- ++(-2,0) |- (encoder.west)
        node [midway, above, font=\small] {Update Encoder Weights};

    \end{tikzpicture}

    \begin{tikzpicture}[node distance=1cm]

        % --- Title ---
        \node (title) [font=\Large\bfseries] {Stage 2: Classification Fine-tuning};

        % --- Input Data ---
        \node (input) [block, below=of title] {Input Text \\ \small(\texttt{context [SEP] response})};

        % --- RoBERTa Encoder ---
        \node (encoder) [block, below=of input] {RoBERTa Encoder \\ \small\textit{(Weights from Stage 1)}};
        \draw [main_arrow] (input) -- (encoder);

        % --- Classifier Head ---
        \node (classifier) [block, below=of encoder] {Classifier Head \\ \small(e.g., Linear Layer + Softmax)};
        \draw [main_arrow] (encoder) -- (classifier) node [midway, right, font=\small] {CLS Token Embedding};

        % --- Final Prediction ---
        \node (prediction) [output, below=of classifier] {Prediction};
        \draw [main_arrow] (classifier) -- (prediction);

        % --- Loss Calculation (Revised Style) ---
        \node (loss) [block, below=of prediction] {Cross-Entropy Loss};
        \draw [main_arrow] (prediction) -- (loss);

        % Replace the block with a simple text node for the label
        \node (label_text) [above left=0.3cm and -2cm of loss] {True Label};
        \draw [main_arrow] (label_text) -| (loss.north);

        % --- Weight Update Paths ---
        % Path to update the classifier (rerouted to the right)
        \draw [update_arrow] (loss.east) -- ++(2,0) |- (classifier.east)
        node [midway, above, font=\small] {Update};

        % Path to update the main encoder (originating from a clean point)
        \draw [update_arrow] (loss.west) -- ++(-2,0) |- (encoder.west)
        node [midway, above, font=\small] {Fine-tune};

    \end{tikzpicture}
\end{document}